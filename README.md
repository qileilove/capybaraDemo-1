# capybaraDemo

This repository has a simple example of running [Capybara](https://github.com/jnicklas/capybara) in a [Docker](www.docker.com) container.

The tests may be run against Firefox, Chrome, or Poltergeist/Phantomjs.
It also includes support for [screenshots](mattheworiordan/capybara-screenshot) of failed tests cases

## Overview

The docker image `capybara_demo` contains all of the tools and libraries required to run Capybara against Firefox, Chrome or Phantomjs.

The directory `demo` is mounted into the docker container under the directory `/capybara`, giving the tools in the container access to
all of the cucumber/capybara test files defined in `demo`.

The script `runCucmber.sh` is executed from within docker. It handles any runtime setup (such as starting Xvfb if necessary), and
then executes cucumber.

A report of the test execution is written to `demo/output`.

## How to run

### Step 1 - Build the reporter jar

Though cucumber comes with several different reports, I think the most useful is an html report generated by
a separate project, [cucumber-reporting](https://github.com/masterthought/cucumber-reporting). Normally, cucumber-reporting
is used as a Jenkins plugin that converts the standard JSON report produced by Cucumber into an elegant HTML format.
To run it from the command line outside of Jenkins, we need to build a small Java app. The `dockerBuild.sh` script
will add this jar to the docker image, and the `runCucumber.sh` script in the image will run the Java app to generate
a nice report after cucumber is done.

To build the Java app,

```
$ cd reporter
$ mvn -s ./settings.xml package
```

### Step 2 - Build the docker image

This step only needs to be performed once on a given machine.
On the first execution, the build will take several minutes.
Docker will cache the resulting image locally so that any subsequent attempts will be much faster


```
$ ./dockerBuild.sh
```
### Step 3 - Run the test suite against one of the browsers

The Selenium driver for Capybara is the default, and by default it executes tests againts Firefox.

```
$ ./dockerRun.sh
or
$ ./dockerRun.sh -d selenium
```

To run against Chrome,

```
$ ./dockerRun.sh -d selenium_chrome
```

To run against Poltergeist/Phantomjs,

```
$ ./dockerRun.sh -d poltergeist
```

### Step 4 - Review the test results

The output from the tests are written to stdout as the tests execute. Additionally, an HTML report is written to
`demo/output/features-overview.html`. If a test case fails, the HTML report will include a screenshot of the browser
at the point in time when the test case failed.

### Cucumber Command Line Options
Cucumber command line options can be specified by defining the environment variable `CUCUMBER_OPTS` on the make command line.

### Environment variables
Environment variables are used to pass information into the docker container.

The variables `CALLER_UID` and `CALLER_GID` capture the current users UID and GID which are used in the container to create a `cuke` user so that
files written to `demo/output` will have the proper owner/group information (for OSX, see Known Issues).

Other variables set bu `dockerRun.sh` are:

 * **`CAPYBARA_DRIVER`** - the name of the Capybara web driver to use. Valid values are `selenium` (which uses Firefox), `selenium_chrome`, or `poltergeist` (which uses PhantomJS). The default if not specified is "selenium"
 * **`CAPYBARA_TIMEOUT`** - the timeout, in seconds, that Capybara should wait for a page or element. The default is 10 seconds.
 * **`CUCUMBER_OPTS`** - any of the standard command line options for Cucumber.

For details of how these variables are used, see [demo/features/support/env.rb](demo/features/support/env.rb)

For a full list of possible options for Cucumber itself, specify `--help`

```
$ CUCUMBER_OPTS=--help ./dockerRun.sh
```

## TODOs

 * Illustrate passing current host name and/or IP into the docker container
 * Illustrate support for Page Object Model with [Site Prism](https://github.com/natritmeyer/site_prism)
 * Include a failed test case to illustrate error reporting
 * Illustrate use of tags (reports and running just some)

## Known Issues

 * Phantomjs crashes on click of the Search button - [phantomjs/issues/13055](https://github.com/ariya/phantomjs/issues/13055)
 * On Mac OSX with [boot2docker](http://boot2docker.io/), you must use the `--root` option for `dockerRun.sh` and
 boot2docker will automagically maps the root user of the docker container to the current user of the host OS. Without the `--root` option, you will encounter permission problems trying to write files into the `demo/output` directory.

## References

 * [Docker](www.docker.com)
 * [Cucumber - A tool for BDD testing](https://github.com/cucumber/cucumber)
 * [Capybara - An Acceptance test framework for web applications](https://github.com/jnicklas/capybara)
 * [Capybara cheat sheet](https://gist.github.com/zhengjia/428105)
 * [How to install PhantomJS on Ubuntu](https://gist.github.com/julionc/7476620)
 * [Notes on setting up Xvfb for docker](https://github.com/keyvanfatehi/docker-chrome-xvfb)
 * [How to install Chromedriver on Ubuntu](https://devblog.supportbee.com/2014/10/27/setting-up-cucumber-to-run-with-Chrome-on-Linux/)
 * [How to install Chrome from the command line](http://askubuntu.com/questions/79280/how-to-install-chrome-browser-properly-via-command-line)
 * [URLs for different versions of Chrome](http://www.ubuntuupdates.org/package/google_chrome/stable/main/base/google-chrome-stable)
 * [Chromedriver options](https://sites.google.com/a/chromium.org/chromedriver/capabilities)
 * [Chrome options](http://peter.sh/experiments/chromium-command-line-switches/)
